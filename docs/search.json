[
  {
    "objectID": "tsir_r0.html#fitting-for-districts",
    "href": "tsir_r0.html#fitting-for-districts",
    "title": "6  Estimating the basic reproduction rate of HFMD using the time series SIR model in Ho Chi Minh City",
    "section": "6.1 Fitting for districts",
    "text": "6.1 Fitting for districts\ngam model for birth data for population: how to generate\n\n\nCode\ncutpoint1 &lt;- function(data,point){\n  fitt &lt;- mgcv::gam(birth ~ s(week) + s(week2),\n                    method = \"REML\",data = data[-c(point:nrow(child1)),])\n  \n  new_data2 &lt;- data.frame(week = rep(1:52,7))\n  \n  new_data2$week2 &lt;- seq(1,nrow(new_data2))\n  new_data2$year &lt;- rep(2017:2023,each = 52)\n  \n  time &lt;- data.frame()\n  for (i in 2017:2023){\n    range &lt;- new_data2$week[new_data2$year == i]\n    time_add &lt;- data.frame(seq.int(i + 7/365 ,(i+1) - 7/365,\n                                   length.out = length(range)))\n    time &lt;- rbind(time,time_add)\n  }\n  \n  new_data2[4] &lt;- time %&gt;%\n    magrittr::set_colnames(c(\"time\"))\n  \n  est2 &lt;- predict.gam(fitt,newdata = new_data2,\n                      type=\"response\",se.fit = TRUE)\n  \n  new_data2 &lt;- new_data2 %&gt;% mutate(\n    fit = est2$fit,\n    lwr = est2$fit - qt(0.95,nrow(new_data2))*est2$se.fit,\n    upr = est2$fit + qt(0.95,nrow(new_data2))*est2$se.fit,\n  )\n  out &lt;- list()\n  out$point &lt;- point\n  out$df &lt;- new_data2\n  return(out)\n}\n\n\n\n\nCode\nhcm_birth_data &lt;- readRDS(\"D:/OUCRU/hfmd/hcm_birth_data.rds\")\nhcm_birth_data$district_reg &lt;- hcm_birth_data$district_reg %&gt;% \n                    str_replace_all(c(\"Quận 2\"  = \"Thủ Đức\",\n                                      \"Quận 9\"  = \"Thủ Đức\"))\n\ndistrict &lt;- hcm_birth_data$district_reg %&gt;% unique()\n\n\noutcome2 &lt;- data.frame()\n\nfor (t in 1: length(district)){\n  child1 &lt;- hcm_birth_data %&gt;% \n    filter(district_reg == district[t] & birth_year &gt;= 2017) %&gt;% \n    group_by(birth_week,birth_year) %&gt;% summarise(n = sum(n)) %&gt;% \n    arrange(birth_year) \n  colnames(child1) &lt;- c(\"week\",\"year\",\"birth\")\n  child1$week &lt;- ifelse(child1$week == 53,52,child1$week)\n  \n  child1 &lt;- child1 %&gt;% group_by(year) %&gt;%\n    mutate(newn = ifelse(week == 52, sum(birth[week==52]), birth)) %&gt;%\n    {data.frame(.$week, .$year, .$newn )} %&gt;% unique() %&gt;%\n    magrittr::set_colnames(c(\"week\",\"year\",\"birth\"))\n  \n  child1$week2 &lt;- seq(1:length(child1$week))\n  \n  time &lt;- data.frame()\n  \n  for (i in 2017:2022){\n    range &lt;- child1$week[child1$year == i]\n    if (length(range) == 52){\n      time_add &lt;- seq.int(i + 7/365 ,(i+1) - 7/365,\n                          length.out = length(range)) %&gt;% data.frame()\n    } else {\n      time_add &lt;- seq.int(i + 7/365 ,(i+1) - 7/365,\n                          length.out = 52)[1:length(range)] %&gt;% data.frame()\n    }\n    time &lt;- rbind(time,time_add)\n  }\n  \n  \n  child1[,5] &lt;- time %&gt;%\n    magrittr::set_colnames(c(\"time\"))\n  \n  ## model fitting\n  fit1 &lt;- mgcv::gam(birth ~ s(week) + s(week2),method = \"REML\",data = child1) \n  \n  model &lt;- cutpoint1(child1,270)\n\n  outcome &lt;- data.frame(district = rep(district[t],\n                                       length(model$df$time)),\n                        week = model$df$week,\n                        year = model$df$year,\n                        # time = model$df$time,\n                        birth = model$df$fit)\n  outcome2 &lt;- rbind(outcome2,outcome)\n}\n\n\n\n\nCode\n### case\n\ndis &lt;- df1 %&gt;% filter(year(adm_week) &gt;= \"2017\" & year(adm_week) &lt;= \"2023\") %&gt;%\n  filter(!is.na(adm_week) ) %&gt;% group_by(district) %&gt;% \n  count(adm_week) %&gt;% as.data.frame()\n\n\ndistrict2 &lt;- dis$district %&gt;% unique()\n\ncaseqh1 &lt;- data.frame() \n\nfor (i in 1:length(district2)){\n  dtech &lt;- dis %&gt;% filter(district == district2[i])\n  caseqh &lt;- data.frame()\n  for (t in 2017:2023){\n    tt &lt;- dtech %&gt;% filter(year(adm_week) == t) %&gt;%\n      filter(!is.na(adm_week) ) %&gt;% \n      as.data.frame()\n    fulldate &lt;- seq(tt$adm_week[1],tt$adm_week[nrow(tt)],by=\"week\")\n    \n    checkdate &lt;- data.frame(week= fulldate ,\n                            n = rep(0,length(fulldate)))\n    \n    dtf &lt;- full_join(checkdate,tt,by = c(\"week\" = \"adm_week\")) %&gt;% \n      select(\"district\",\"week\",\"n.y\")\n    \n    dtf$district &lt;- replace(dtf$district,is.na(dtf$district),district2[i])\n    dtf$n.y &lt;- replace(dtf$n.y,is.na(dtf$n.y),0)\n    colnames(dtf) &lt;- c(\"district\",\"date\",\"case\")\n    dtf$week &lt;- seq(1,nrow(dtf))\n    dtf$week &lt;- ifelse(dtf$week == 53,52,dtf$week)\n    dtf$case &lt;- ifelse(dtf$week == 52, sum(dtf$case[dtf$week==52]), dtf$case)\n    dtf &lt;- dtf[-53,]\n    dtf$time &lt;- seq.int(t + 7/365 ,(t+1) - 7/365,\n                               length.out = nrow(dtf))\n    dtf$year &lt;- year(dtf$date)\n    caseqh &lt;- rbind(caseqh,dtf)\n  }\n  caseqh1 &lt;- rbind(caseqh1,caseqh)\n}  \n\noutcome2$district &lt;- outcome2$district %&gt;%\n  str_remove_all(\"Quận\") %&gt;% \n  trimws(which = \"both\") \n  \noutcome2$district &lt;- outcome2$district %&gt;% str_replace_all(\n  c(\"Gò vấp\" = \"Gò Vấp\"))\n\naftt &lt;- full_join(caseqh1,outcome2,by = c(\"district\" = \"district\",\n                                  \"week\" = \"week\",\n                                  \"year\" = \"year\")) %&gt;% \n  select(\"district\",\"week\",\"year\",\"date\",\"case\",\"birth\",\"time\")\n\naftt &lt;-  aftt %&gt;% na.omit() \n\n\n\n\nCode\ncensus2019 &lt;- readRDS(\"D:/OUCRU/hfmd/data/census2019.rds\")\ncensus2019$district &lt;- census2019$district %&gt;% \n  str_replace_all(c(\"Quận 2\"  = \"Quận Thủ Đức\",\n                  \"Quận 9\"  = \"Quận Thủ Đức\")) %&gt;% \n  str_remove_all(\"Quận|Huyện\") %&gt;% \n  trimws(which = \"both\") \n\n\npopqh &lt;- census2019 %&gt;% filter(province == \"Thành phố Hồ Chí Minh\") %&gt;% \n  group_by(district) %&gt;% summarise(pop = sum(n)) \n\npop19 &lt;- popqh %&gt;% filter(district == district[1]) %&gt;% select(pop) %&gt;% \n  as.numeric()\n\nr1920 &lt;- 9227.6/9038.6\nr2021 &lt;- 9166.8/9227.6\nr2122 &lt;- 9389.7/9166.8\nr2223 &lt;- 9456.7/9389.7\n\npopqh$pop20 &lt;- popqh$pop*r1920 \npopqh$pop21 &lt;- popqh$pop20*r2021 \npopqh$pop22 &lt;- popqh$pop21*r2122 \npopqh$pop23 &lt;- popqh$pop22*r2223 \npopqh$pop24 &lt;- popqh$pop23*r2223 \n\n\ndatatsir &lt;- data.frame()\n\nfor (i in 1:22){\n  qh2 &lt;- data.frame()\n  for (t in 2019:2023){\n    pop1 &lt;- popqh %&gt;% filter(district == district2[i])\n    qh1 &lt;- aftt %&gt;% filter(district == district2[i] & year == t)\n    k &lt;- case_when(\n      t == 2019 ~ 2,\n      t == 2020 ~ 3,\n      t == 2021 ~ 4,\n      t == 2022 ~ 5,\n      t == 2023 ~ 6\n    )\n    mod2 &lt;- generator$new(N0 = as.numeric(pop1[,k]),\n                          r = 7.4/52,K= as.numeric(pop1[,k+1]))\n    popq &lt;- mod2$run(1:nrow(qh1))\n    qh15 &lt;- cbind(qh1,popq[,-1])\n    qh2 &lt;- rbind(qh2,qh15)\n  }\n  datatsir &lt;- rbind(datatsir,qh2)\n}\n\n\ncolnames(datatsir) &lt;- c(colnames(datatsir[-8]),\"pop\")\n\n\n\n\nCode\n## tsir fitting\ncalda &lt;- data.frame()\nbeta &lt;- data.frame()\nfor (i in 1:22){\n  calda1 &lt;- datatsir %&gt;% filter(district == district2[i] & time &gt;=2022) %&gt;% \n    select(\"time\",\"case\",\"birth\",\"pop\") %&gt;% \n    magrittr::set_colnames(c(\"time\",\"cases\",\"births\",\"pop\"))\n  \n  re &lt;- runtsir(data = calda1, IP = 1, xreg = \"cumcases\", \n                regtype = \"gaussian\",alpha = NULL, sbar = NULL, \n                method = \"deterministic\", nsim = 1000,\n                family = \"gaussian\", link = \"identity\")\n  \n  calda1$fit &lt;- re$res$mean\n  calda1$s &lt;- re$simS$mean\n  calda1$district &lt;- rep(district2[i],nrow(calda1))\n  beta1 &lt;- re$contact\n  beta1$district &lt;- rep(district2[i],nrow(beta1))\n  calda &lt;- rbind(calda,calda1)\n  beta &lt;- rbind(beta,beta1)\n}\n\n\nsuscepdata &lt;- calda %&gt;% filter(time &gt;= 2023) %&gt;% \n  select(\"time\",\"district\",\"cases\",\"s\")\n\nrodt1 &lt;- data.frame()\nfor (i in 1:22){\n  r0dt &lt;- suscepdata %&gt;% filter(district == district2[i]) %&gt;% \n    mutate(week = seq(1:nrow(.)))\n  rodt1 &lt;- rbind(rodt1,r0dt)\n}\n\nro &lt;- full_join(rodt1,beta,by = c(\"week\" = \"time\",\n                            \"district\" = \"district\")) %&gt;% na.omit()\n\nro$ro &lt;- ro$beta*ro$s\n\n\n\n\nCode\ncalda %&gt;% \n  ggplot() +\n  geom_line(aes(x = time ,group = 1, y = fit,\n                linetype = \"model fitted\"))+\n  geom_line(aes(x= time, group = 1, y = cases,\n                linetype = \"cases reported\"))+\n  # geom_bar(aes(x= as.character(date), y = cases),stat = \"identity\")+\n  theme_bw()+\n  labs(y = \"Cases\",x=\"Time\")+\n  facet_wrap(vars(district),scales = \"free\")+\n  scale_linetype_manual(values = c(\"cases reported\" = \"dashed\",\n                                   \"model fitted\" = \"solid\"),\n                        name=\"Analysis Type\")+\n  scale_x_continuous(breaks = seq(2022,2024,1))"
  }
]